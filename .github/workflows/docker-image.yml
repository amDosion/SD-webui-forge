name: SD-WebUI Docker

on:
  schedule:
    - cron: '0 */6 * * *'  # æ¯ 6 å°æ—¶æ£€æŸ¥ä¸€æ¬¡
  workflow_dispatch:      # å¯æ‰‹åŠ¨è§¦å‘

jobs:
  check-and-build:
    runs-on: ubuntu-latest
    env:
      FORGE_REPO: https://github.com/lllyasviel/stable-diffusion-webui-forge.git
      AUTO_REPO: https://github.com/AUTOMATIC1111/stable-diffusion-webui.git

    steps:
      - name: â¬ Checkout current repo
        uses: actions/checkout@v3

      - name: ðŸ” Clone and check upstream forge HEAD
        run: |
          git clone --depth=1 $FORGE_REPO forge-latest
          echo "::set-output name=forge_sha::$(cd forge-latest && git rev-parse HEAD)"
        id: forge

      - name: ðŸ” Clone and check upstream auto HEAD
        run: |
          git clone --depth=1 $AUTO_REPO auto-latest
          echo "::set-output name=auto_sha::$(cd auto-latest && git rev-parse HEAD)"
        id: auto

      - name: ðŸ“¦ Compare with cached version
        id: check
        run: |
          echo "FORGE_SHA=${{ steps.forge.outputs.forge_sha }}" >> forge-latest-sha.txt
          echo "AUTO_SHA=${{ steps.auto.outputs.auto_sha }}" >> auto-latest-sha.txt

          # æ£€æŸ¥æ˜¯å¦å˜åŒ–ï¼ˆç®€å•å¯¹æ¯” SHAï¼‰
          if [ -f .sha_cache ]; then
            if cmp -s .sha_cache forge-latest-sha.txt && cmp -s .sha_cache auto-latest-sha.txt; then
              echo "âœ… No changes detected in upstream repos."
              echo "changed=false" >> $GITHUB_OUTPUT
              exit 0
            fi
          fi

          echo "ðŸ” Detected changes in upstream!"
          cat forge-latest-sha.txt > .sha_cache
          cat auto-latest-sha.txt >> .sha_cache
          echo "changed=true" >> $GITHUB_OUTPUT

      - name: ðŸš€ Rebuild Docker image
        if: steps.check.outputs.changed == 'true'
        run: |
          docker buildx create --use
          docker buildx build \
            --platform linux/amd64 \
            --no-cache \
            -t chuan1127/webui-auto:latest \
            --push .

      - name: ðŸ§¹ Clean up
        run: |
          rm -rf forge-latest auto-latest forge-latest-sha.txt auto-latest-sha.txt
